<style>
    .cf-container {
        padding: 15px;
    }
    
    .cf-section {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .cf-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .cf-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 30px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafafa;
    }
    
    .cf-upload-area:hover {
        border-color: #20a53a;
        background: #f0faf2;
    }
    
    .cf-upload-area.dragover {
        border-color: #20a53a;
        background: #e8f5e9;
    }
    
    .cf-upload-icon {
        font-size: 36px;
        color: #ccc;
        margin-bottom: 8px;
    }
    
    .cf-upload-text {
        color: #666;
        margin-bottom: 5px;
        font-size: 13px;
    }
    
    .cf-upload-hint {
        font-size: 12px;
        color: #999;
    }
    
    .cf-font-list {
        margin-top: 10px;
    }
    
    .cf-font-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 6px;
        margin-bottom: 8px;
        transition: all 0.3s;
    }
    
    .cf-font-item:hover {
        border-color: #20a53a;
        box-shadow: 0 2px 8px rgba(32, 165, 58, 0.1);
    }
    
    .cf-font-item.active-regular {
        border-color: #20a53a;
        background: #f0faf2;
    }
    
    .cf-font-item.active-bold {
        border-color: #1890ff;
        background: #e6f7ff;
    }
    
    .cf-font-info {
        flex: 1;
    }
    
    .cf-font-name {
        font-size: 13px;
        font-weight: 500;
        color: #333;
        margin-bottom: 3px;
    }
    
    .cf-font-meta {
        font-size: 11px;
        color: #999;
    }
    
    .cf-font-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .cf-btn {
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        border: none;
        transition: all 0.3s;
    }
    
    .cf-btn-primary {
        background: #20a53a;
        color: #fff;
    }
    
    .cf-btn-primary:hover {
        background: #1a8a30;
    }
    
    .cf-btn-info {
        background: #1890ff;
        color: #fff;
    }
    
    .cf-btn-info:hover {
        background: #096dd9;
    }
    
    .cf-btn-default {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
    }
    
    .cf-btn-default:hover {
        background: #e8e8e8;
    }
    
    .cf-btn-danger {
        background: #ff5722;
        color: #fff;
    }
    
    .cf-btn-danger:hover {
        background: #e64a19;
    }
    
    .cf-empty {
        text-align: center;
        padding: 30px;
        color: #999;
    }
    
    .cf-empty-icon {
        font-size: 36px;
        color: #ddd;
        margin-bottom: 8px;
    }
    
    .cf-status-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        margin-left: 6px;
    }
    
    .cf-status-badge.regular {
        background: #e8f5e9;
        color: #20a53a;
    }
    
    .cf-status-badge.bold {
        background: #e6f7ff;
        color: #1890ff;
    }
    
    .cf-preview-box {
        margin-top: 12px;
        padding: 15px;
        background: #fafafa;
        border-radius: 6px;
        text-align: center;
    }
    
    .cf-preview-text {
        font-size: 20px;
        margin-bottom: 8px;
    }
    
    .cf-preview-subtext {
        font-size: 13px;
        color: #666;
    }
    
    .cf-progress {
        display: none;
        margin-top: 10px;
    }
    
    .cf-progress-bar {
        height: 5px;
        background: #eee;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .cf-progress-inner {
        height: 100%;
        background: #20a53a;
        width: 0%;
        transition: width 0.3s;
    }
    
    .cf-progress-text {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
    }
    
    .cf-apply-section {
        background: #f6f8f8;
        border-radius: 6px;
        padding: 12px;
        margin-top: 15px;
    }
    
    .cf-apply-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .cf-apply-row:last-child {
        margin-bottom: 0;
    }
    
    .cf-apply-label {
        width: 80px;
        font-size: 13px;
        color: #666;
    }
    
    .cf-apply-select {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .cf-apply-btns {
        display: flex;
        gap: 10px;
        margin-top: 12px;
    }
</style>
<div class="bt-form">
    <div class="bt-w-main">
        <div class="bt-w-menu">
            <p class="bgw" onclick="customfont.show_overview()">æ¦‚è§ˆ</p>
            <p onclick="customfont.show_fonts()">å­—ä½“ç®¡ç†</p>
            <p onclick="customfont.show_help()">ä½¿ç”¨å¸®åŠ©</p>
            <p onclick="customfont.show_about()">å…³äº</p>
        </div>
        <div class="bt-w-con pd15">
            <div class="plugin_body cf-container"></div>
        </div>
    </div>
</div>

<input type="file" id="cf-file-input" accept=".ttf" style="display:none">

<script type="text/javascript">
var customfont = {
    current_fonts: [],
    current_regular_font: '',
    current_bold_font: '',
    loaded_fonts: {},
    
    init: function() {
        $('.layui-layer-page').css({ 'width': '900px' });
        $(".bt-w-menu p").click(function () {
            $(this).addClass('bgw').siblings().removeClass('bgw');
        });
        $('#cf-file-input').on('change', function(e) {
            customfont.handle_file_select(e);
        });
        this.show_overview();
    },
    
    load_font_for_preview: function(font_id, font_url) {
        var self = this;
        if (this.loaded_fonts[font_id]) {
            return Promise.resolve(this.loaded_fonts[font_id]);
        }
        return new Promise(function(resolve, reject) {
            var font_name = 'CustomFont-' + font_id;
            var font_face = new FontFace(font_name, 'url(' + font_url + ')');
            font_face.load().then(function(loaded_face) {
                document.fonts.add(loaded_face);
                self.loaded_fonts[font_id] = font_name;
                resolve(font_name);
            }).catch(function(error) {
                reject(error);
            });
        });
    },
    
    show_overview: function() {
        var self = this;
        this.request('get_fonts', {}, function(res) {
            if (res.status) {
                self.current_fonts = res.data.fonts || [];
                self.current_regular_font = res.data.current_regular_font || '';
                self.current_bold_font = res.data.current_bold_font || '';
            }
            
            var regular_name = 'é»˜è®¤å­—ä½“';
            var bold_name = 'é»˜è®¤å­—ä½“';
            
            if (self.current_regular_font) {
                for (var i = 0; i < self.current_fonts.length; i++) {
                    if (self.current_fonts[i].id === self.current_regular_font) {
                        regular_name = self.current_fonts[i].name;
                        break;
                    }
                }
            }
            
            if (self.current_bold_font) {
                for (var i = 0; i < self.current_fonts.length; i++) {
                    if (self.current_fonts[i].id === self.current_bold_font) {
                        bold_name = self.current_fonts[i].name;
                        break;
                    }
                }
            }
            
            var html = '<div class="cf-section">' +
                '<div class="cf-section-title">å½“å‰çŠ¶æ€ <span style="font-size:11px;color:#999;font-weight:normal;">v1.2.3</span></div>' +
                '<div style="padding: 8px 0;">' +
                    '<p style="margin-bottom: 8px;"><strong>å¸¸è§„å­—ä½“ï¼š</strong><span style="color: #20a53a;">' + regular_name + '</span></p>' +
                    '<p style="margin-bottom: 8px;"><strong>ç²—ä½“å­—ä½“ï¼š</strong><span style="color: #1890ff;">' + bold_name + '</span></p>' +
                    '<p style="margin-bottom: 8px;"><strong>å·²ä¸Šä¼ å­—ä½“ï¼š</strong>' + self.current_fonts.length + ' ä¸ª</p>' +
                '</div>' +
                            '<div class="cf-preview-box" id="cf-preview-box">' +
                                '<div class="cf-preview-text" id="cf-preview-text">é¢æ¿è‡ªå®šä¹‰å­—ä½“é¢„è§ˆ</div>' +
                                '<div class="cf-preview-subtext" id="cf-preview-subtext">The quick brown fox jumps over the lazy dog</div>' +
                                '<div class="cf-preview-subtext" id="cf-preview-subtext2" style="margin-top: 5px;">è¿™æ˜¯ä¸€æ®µä¸­æ–‡é¢„è§ˆæ–‡å­—ï¼Œæµ‹è¯•å­—ä½“æ•ˆæœ</div>' +
                                '<div style="margin-top: 15px; text-align: center;">' +
                                    '<button class="cf-btn cf-btn-default" onclick="customfont.toggle_preview_font()">åˆ‡æ¢é¢„è§ˆå­—ä½“</button>' +
                                '</div>' +
                            '</div>' +            '</div>' +
            '<div class="cf-section">' +
                '<div class="cf-section-title">å¿«é€Ÿæ“ä½œ</div>' +
                '<div class="cf-apply-btns">' +
                    '<button class="cf-btn cf-btn-primary" onclick="customfont.go_to_fonts()">ç®¡ç†å­—ä½“</button>' +
                    '<button class="cf-btn cf-btn-default" onclick="customfont.reset_font()">æ¢å¤é»˜è®¤å­—ä½“</button>' +
                '</div>' +
            '</div>';
            
            $('.plugin_body').html(html);
        });
    },
    
    show_fonts: function() {
        var self = this;
        this.request('get_fonts', {}, function(res) {
            if (res.status) {
                self.current_fonts = res.data.fonts || [];
                self.current_regular_font = res.data.current_regular_font || '';
                self.current_bold_font = res.data.current_bold_font || '';
            }
            
            var font_list_html = '';
            if (self.current_fonts.length > 0) {
                for (var i = 0; i < self.current_fonts.length; i++) {
                    var font = self.current_fonts[i];
                    var is_regular = font.id === self.current_regular_font;
                    var is_bold = font.id === self.current_bold_font;
                    var size_kb = (font.size / 1024).toFixed(1);
                    
                    var item_class = '';
                    var badge = '';
                    if (is_regular) {
                        item_class = ' active-regular';
                        badge = '<span class="cf-status-badge regular">å¸¸è§„</span>';
                    }
                    if (is_bold) {
                        item_class = ' active-bold';
                        badge += '<span class="cf-status-badge bold">ç²—ä½“</span>';
                    }
                    
                    font_list_html += '<div class="cf-font-item' + item_class + '" data-font-id="' + font.id + '">' +
                        '<div class="cf-font-info">' +
                            '<div class="cf-font-name">' + font.name + badge + '</div>' +
                            '<div class="cf-font-meta">' + font.ext.toUpperCase() + ' | ' + size_kb + ' KB | ' + font.addtime + '</div>' +
                        '</div>' +
                        '<div class="cf-font-actions">' +
                            '<button class="cf-btn cf-btn-primary" onclick="customfont.set_as_regular(\'' + font.id + '\')">è®¾ä¸ºå¸¸è§„</button>' +
                            '<button class="cf-btn cf-btn-info" onclick="customfont.set_as_bold(\'' + font.id + '\')">è®¾ä¸ºç²—ä½“</button>' +
                            '<button class="cf-btn cf-btn-default" onclick="customfont.preview_font_detail(\'' + font.id + '\')">é¢„è§ˆ</button>' +
                            '<button class="cf-btn cf-btn-danger" onclick="customfont.delete_font(\'' + font.id + '\', \'' + font.name.replace(/'/g, "\\'") + '\')">åˆ é™¤</button>' +
                        '</div>' +
                    '</div>';
                }
            } else {
                font_list_html = '<div class="cf-empty">' +
                    '<div class="cf-empty-icon">ğŸ“</div>' +
                    '<p>æš‚æ— å·²ä¸Šä¼ çš„å­—ä½“</p>' +
                '</div>';
            }
            
            // æ„å»ºé€‰æ‹©æ¡†é€‰é¡¹
            var select_options = '<option value="">-- ä¸æ›´æ”¹ --</option>';
            for (var i = 0; i < self.current_fonts.length; i++) {
                var font = self.current_fonts[i];
                select_options += '<option value="' + font.id + '">' + font.name + '</option>';
            }
            
            var html = '<div class="cf-section">' +
                '<div class="cf-section-title">ä¸Šä¼ å­—ä½“</div>' +
                '<div class="cf-upload-area" id="cf-upload-area" onclick="document.getElementById(\'cf-file-input\').click()">' +
                    '<div class="cf-upload-icon">ğŸ“¤</div>' +
                    '<div class="cf-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å­—ä½“æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>' +
                    '<div class="cf-upload-hint">ä»…æ”¯æŒTTFæ ¼å¼ | æœ€å¤§10MB</div>' +
                '</div>' +
                '<div class="cf-progress" id="cf-progress">' +
                    '<div class="cf-progress-bar"><div class="cf-progress-inner" id="cf-progress-inner"></div></div>' +
                    '<div class="cf-progress-text" id="cf-progress-text">ä¸Šä¼ ä¸­...</div>' +
                '</div>' +
            '</div>' +
            '<div class="cf-section">' +
                '<div class="cf-section-title">å·²ä¸Šä¼ å­—ä½“ (' + self.current_fonts.length + ')</div>' +
                '<div class="cf-font-list">' + font_list_html + '</div>' +
                '<div class="cf-apply-section">' +
                    '<div class="cf-apply-row">' +
                        '<span class="cf-apply-label">å¸¸è§„å­—ä½“ï¼š</span>' +
                        '<select class="cf-apply-select" id="cf-regular-select">' + select_options + '</select>' +
                    '</div>' +
                    '<div class="cf-apply-row">' +
                        '<span class="cf-apply-label">ç²—ä½“å­—ä½“ï¼š</span>' +
                        '<select class="cf-apply-select" id="cf-bold-select">' + select_options + '</select>' +
                    '</div>' +
                    '<div class="cf-apply-btns">' +
                        '<button class="cf-btn cf-btn-primary" onclick="customfont.apply_fonts()">åº”ç”¨è®¾ç½®</button>' +
                        '<button class="cf-btn cf-btn-default" onclick="customfont.reset_font()">æ¢å¤é»˜è®¤</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            $('.plugin_body').html(html);
            
            // è®¾ç½®å½“å‰é€‰ä¸­å€¼
            if (self.current_regular_font) {
                $('#cf-regular-select').val(self.current_regular_font);
            }
            if (self.current_bold_font) {
                $('#cf-bold-select').val(self.current_bold_font);
            }
            
            self.bind_drag_events();
        });
    },
    
    set_as_regular: function(font_id) {
        $('#cf-regular-select').val(font_id);
        layer.msg('å·²é€‰æ‹©ä¸ºå¸¸è§„å­—ä½“ï¼Œè¯·ç‚¹å‡»"åº”ç”¨è®¾ç½®"ç”Ÿæ•ˆ', {icon: 1, time: 2000});
    },
    
    set_as_bold: function(font_id) {
        $('#cf-bold-select').val(font_id);
        layer.msg('å·²é€‰æ‹©ä¸ºç²—ä½“å­—ä½“ï¼Œè¯·ç‚¹å‡»"åº”ç”¨è®¾ç½®"ç”Ÿæ•ˆ', {icon: 1, time: 2000});
    },
    
    apply_fonts: function() {
        var regular_id = $('#cf-regular-select').val() || '';
        var bold_id = $('#cf-bold-select').val() || '';
        
        if (!regular_id && !bold_id) {
            layer.msg('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å­—ä½“', {icon: 2});
            return;
        }
        
        var self = this;
        layer.confirm('ç¡®å®šè¦åº”ç”¨å­—ä½“è®¾ç½®å—ï¼Ÿåº”ç”¨ååˆ·æ–°é¡µé¢å³å¯ç”Ÿæ•ˆã€‚', {title: 'æç¤º'}, function(index) {
            layer.close(index);
            var load_index = layer.msg('æ­£åœ¨åº”ç”¨å­—ä½“...', {icon: 16, time: 0});
            self.request('apply_font', {regular_font_id: regular_id, bold_font_id: bold_id}, function(res) {
                layer.close(load_index);
                layer.msg(res.msg, {icon: res.status ? 1 : 2});
                if (res.status) {
                    self.current_regular_font = regular_id;
                    self.current_bold_font = bold_id;
                    self.show_fonts();
                }
            });
        });
    },
    
    preview_font_detail: function(font_id) {
        var self = this;
        var font = null;
        for (var i = 0; i < this.current_fonts.length; i++) {
            if (this.current_fonts[i].id === font_id) {
                font = this.current_fonts[i];
                break;
            }
        }
        
        if (!font) {
            layer.msg('å­—ä½“ä¸å­˜åœ¨', {icon: 2});
            return;
        }
        
        var font_url = '/customfont/static/fonts/' + font.filename;
        var load_index = layer.msg('æ­£åœ¨åŠ è½½å­—ä½“...', {icon: 16, time: 0});
        
        this.load_font_for_preview(font_id, font_url).then(function(font_name) {
            layer.close(load_index);
            var preview_html = '<div style="padding: 20px; text-align: center;">' +
                '<h3 style="margin-bottom: 15px; font-family: ' + font_name + ';">' + font.name + '</h3>' +
                '<div style="font-size: 24px; margin: 15px 0; font-family: ' + font_name + ';">é¢æ¿è‡ªå®šä¹‰å­—ä½“é¢„è§ˆ</div>' +
                '<div style="font-size: 16px; margin: 10px 0; font-family: ' + font_name + ';">The quick brown fox jumps over the lazy dog</div>' +
                '<div style="font-size: 14px; margin: 10px 0; font-family: ' + font_name + ';">è¿™æ˜¯ä¸€æ®µä¸­æ–‡é¢„è§ˆæ–‡å­—ï¼Œæµ‹è¯•å­—ä½“æ•ˆæœ</div>' +
                '<div style="font-size: 13px; margin: 10px 0; font-family: ' + font_name + ';">' +
                    'ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>' +
                    'abcdefghijklmnopqrstuvwxyz<br>' +
                    '0123456789' +
                '</div>' +
            '</div>';
            
            layer.open({
                type: 1,
                title: 'å­—ä½“é¢„è§ˆ - ' + font.name,
                area: ['450px', '380px'],
                content: preview_html
            });
        }).catch(function(error) {
            layer.close(load_index);
            layer.msg('å­—ä½“åŠ è½½å¤±è´¥', {icon: 2});
        });
    },
    
    show_help: function() {
        var html = '<div class="cf-section">' +
            '<div class="cf-section-title">ä½¿ç”¨å¸®åŠ©</div>' +
            '<div style="line-height: 1.8; font-size: 12px;">' +
                '<h4 style="margin: 12px 0 8px; color: #333;">1. å…³äºå­—ä½“ç±»å‹</h4>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ <b>å¸¸è§„å­—ä½“</b>ï¼šç”¨äºé¢æ¿å¤§éƒ¨åˆ†æ–‡å­—æ˜¾ç¤º</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ <b>ç²—ä½“å­—ä½“</b>ï¼šç”¨äºæ ‡é¢˜ã€å¼ºè°ƒæ–‡å­—ç­‰</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ å¯ä»¥è®¾ç½®ç›¸åŒå­—ä½“ä½œä¸ºå¸¸è§„å’Œç²—ä½“ä½¿ç”¨</p>' +
                
                '<h4 style="margin: 12px 0 8px; color: #333;">2. å¦‚ä½•ä¸Šä¼ å­—ä½“</h4>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæˆ–æ‹–æ‹½TTFæ–‡ä»¶</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ ä»…æ”¯æŒTTFæ ¼å¼ï¼Œæœ€å¤§10MB</p>' +
                
                '<h4 style="margin: 12px 0 8px; color: #333;">3. å¦‚ä½•åº”ç”¨å­—ä½“</h4>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ æ–¹æ³•ä¸€ï¼šç‚¹å‡»å­—ä½“å³ä¾§"è®¾ä¸ºå¸¸è§„"æˆ–"è®¾ä¸ºç²—ä½“"æŒ‰é’®</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ æ–¹æ³•äºŒï¼šåœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©å­—ä½“åç‚¹å‡»"åº”ç”¨è®¾ç½®"</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°æ•ˆæœ</p>' +
                
                '<h4 style="margin: 12px 0 8px; color: #333;">4. æ³¨æ„äº‹é¡¹</h4>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ å»ºè®®ä½¿ç”¨æ”¯æŒä¸­æ–‡çš„å­—ä½“æ–‡ä»¶</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ åˆ é™¤æ­£åœ¨ä½¿ç”¨çš„å­—ä½“ä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤</p>' +
                '<p style="color: #666; padding-left: 12px;">â€¢ é¢æ¿æ›´æ–°åå¯èƒ½éœ€è¦é‡æ–°åº”ç”¨å­—ä½“</p>' +
            '</div>' +
        '</div>';
        
        $('.plugin_body').html(html);
    },
    
    //æ˜¾ç¤ºå…³äºé¡µé¢
    show_about: function() {
        var html = '<div class="cf-section">' +
            '<div class="cf-section-title">å…³äºæœ¬æ’ä»¶</div>' +
            '<div style="line-height: 1.8;">' +
                '<h4 style="margin: 15px 0 10px; color: #333;">é¡¹ç›®ä¿¡æ¯</h4>' +
                '<p style="color: #666; padding-left: 15px;"><strong>é¡¹ç›®åç§°ï¼š</strong>å®å¡”é¢æ¿è‡ªå®šä¹‰å­—ä½“æ’ä»¶</p>' +
                '<p style="color: #666; padding-left: 15px;"><strong>å½“å‰ç‰ˆæœ¬ï¼š</strong>1.2.3</p>' +
                '<p style="color: #666; padding-left: 15px;"><strong>è®¸å¯è¯ï¼š</strong>MIT License</p>' +
                
                '<h4 style="margin: 15px 0 10px; color: #333;">å¼€æºä¿¡æ¯</h4>' +
                '<p style="color: #666; padding-left: 15px;">é¡¹ç›®å¼€æºåœ°å€ï¼š<a href="https://github.com/5APU-A340/BT-Panel-Font-Custom-Plugin" target="_blank" style="color: #20a53a;">https://github.com/5APU-A340/BT-Panel-Font-Custom-Plugin</a></p>' +
                
                '<h4 style="margin: 15px 0 10px; color: #333;">å¼€å‘è€…ä¿¡æ¯</h4>' +
                '<p style="color: #666; padding-left: 15px;"><strong>å¼€å‘è€…ï¼š</strong>5APU-A340@GitHub</p>' +
                '<p style="color: #666; padding-left: 15px;"><strong>Bilibiliï¼š</strong><a href="https://space.bilibili.com/3546612276136682" target="_blank" style="color: #20a53a;">https://space.bilibili.com/3546612276136682</a></p>' +
                
                '<h4 style="margin: 15px 0 10px; color: #333;">åŠŸèƒ½ç®€ä»‹</h4>' +
                '<p style="color: #666; padding-left: 15px;">â€¢ æ”¯æŒä¸Šä¼ è‡ªå®šä¹‰TTFå­—ä½“æ–‡ä»¶</p>' +
                '<p style="color: #666; padding-left: 15px;">â€¢ å¯åˆ†åˆ«è®¾ç½®å¸¸è§„å­—ä½“å’Œç²—ä½“å­—ä½“</p>' +
                '<p style="color: #666; padding-left: 15px;">â€¢ å…¨å±€æ›¿æ¢é¢æ¿æ‰€æœ‰æ–‡å­—æ˜¾ç¤º</p>' +
                '<p style="color: #666; padding-left: 15px;">â€¢ æ”¯æŒä¸€é”®æ¢å¤é»˜è®¤å­—ä½“</p>' +
                
                '<h4 style="margin: 15px 0 10px; color: #333;">æ„Ÿè°¢ä½¿ç”¨</h4>' +
                '<p style="color: #666; padding-left: 15px;">æœ¬æ’ä»¶éµå¾ªMITå¼€æºåè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–Pull Requestå¸®åŠ©æ”¹è¿›ã€‚</p>' +
            '</div>' +
        '</div>';
        
        $('.plugin_body').html(html);
    },
    
    // åˆ‡æ¢é¢„è§ˆå­—ä½“ç±»å‹ï¼ˆå¸¸è§„/ç²—ä½“ï¼‰
    toggle_preview_font: function() {
        var self = this;
        if (!self.current_regular_font && !self.current_bold_font) {
            layer.msg('è¯·å…ˆåº”ç”¨å­—ä½“', {icon: 2});
            return;
        }
        
        // æŸ¥æ‰¾å½“å‰åº”è¯¥é¢„è§ˆçš„å­—ä½“
        var preview_font_id, preview_font_name, button_text;
        if (self.current_preview_type === 'bold' || !self.current_preview_type) {
            // å½“å‰æ˜¾ç¤ºç²—ä½“æˆ–åˆå§‹çŠ¶æ€ï¼Œåˆ‡æ¢åˆ°å¸¸è§„å­—ä½“é¢„è§ˆ
            preview_font_id = self.current_regular_font;
            preview_font_name = 'å¸¸è§„å­—ä½“';
            self.current_preview_type = 'regular';
            button_text = 'åˆ‡æ¢åˆ°ç²—ä½“é¢„è§ˆ';
        } else {
            // å½“å‰æ˜¾ç¤ºå¸¸è§„å­—ä½“ï¼Œåˆ‡æ¢åˆ°ç²—ä½“é¢„è§ˆ
            preview_font_id = self.current_bold_font;
            preview_font_name = 'ç²—ä½“å­—ä½“';
            self.current_preview_type = 'bold';
            button_text = 'åˆ‡æ¢åˆ°å¸¸è§„é¢„è§ˆ';
        }
        
        if (!preview_font_id) {
            layer.msg('è¯·å…ˆè®¾ç½®' + preview_font_name, {icon: 2});
            return;
        }
        
        // æŸ¥æ‰¾å­—ä½“ä¿¡æ¯
        var font_info = null;
        for (var i = 0; i < self.current_fonts.length; i++) {
            if (self.current_fonts[i].id === preview_font_id) {
                font_info = self.current_fonts[i];
                break;
            }
        }
        
        if (!font_info) {
            layer.msg('å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨', {icon: 2});
            return;
        }
        
        // è®¾ç½®æŒ‰é’®æ–‡æœ¬
        $('#cf-preview-box button').text(button_text);
        
        // åŠ è½½å¹¶åº”ç”¨å­—ä½“é¢„è§ˆ
        var font_url = '/customfont/static/fonts/' + font_info.filename;
        self.load_font_for_preview(font_info.id, font_url).then(function(font_name) {
            $('#cf-preview-text, #cf-preview-subtext, #cf-preview-subtext2').css('font-family', font_name);
            // å¯¹äºç²—ä½“é¢„è§ˆï¼Œå¢åŠ å­—ä½“ç²—ç»†
            if (self.current_preview_type === 'bold') {
                $('#cf-preview-text, #cf-preview-subtext, #cf-preview-subtext2').css('font-weight', 'bold');
            } else {
                $('#cf-preview-text, #cf-preview-subtext, #cf-preview-subtext2').css('font-weight', 'normal');
            }
            layer.msg('æ­£åœ¨é¢„è§ˆ' + preview_font_name, {icon: 1});
        }).catch(function(e) {
            layer.msg('å­—ä½“é¢„è§ˆåŠ è½½å¤±è´¥', {icon: 2});
        });
    },
    
    bind_drag_events: function() {
        var upload_area = document.getElementById('cf-upload-area');
        if (!upload_area) return;
        
        upload_area.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('dragover');
        });
        
        upload_area.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('dragover');
        });
        
        upload_area.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('dragover');
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                customfont.upload_file(files[0]);
            }
        });
    },
    
    handle_file_select: function(e) {
        var files = e.target.files;
        if (files.length > 0) {
            this.upload_file(files[0]);
        }
        e.target.value = '';
    },
    
    upload_file: function(file) {
        var self = this;
        var ext = '.' + file.name.split('.').pop().toLowerCase();
        
        if (ext !== '.ttf') {
            layer.msg('ä»…æ”¯æŒTTFæ ¼å¼å­—ä½“æ–‡ä»¶', {icon: 2});
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            layer.msg('å­—ä½“æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ10MB', {icon: 2});
            return;
        }
        
        $('#cf-progress').show();
        $('#cf-progress-inner').css('width', '0%');
        $('#cf-progress-text').text('ä¸Šä¼ ä¸­...');
        
        var formData = new FormData();
        formData.append('file', file);
        
        var xhr = new XMLHttpRequest();
        
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                var percent = (e.loaded / e.total * 100).toFixed(0);
                $('#cf-progress-inner').css('width', percent + '%');
                $('#cf-progress-text').text('ä¸Šä¼ ä¸­... ' + percent + '%');
            }
        };
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var res = JSON.parse(xhr.responseText);
                    if (res.status) {
                        $('#cf-progress-text').text('ä¸Šä¼ æˆåŠŸï¼');
                        layer.msg(res.msg, {icon: 1});
                        setTimeout(function() {
                            $('#cf-progress').hide();
                            self.show_fonts();
                        }, 800);
                    } else {
                        $('#cf-progress').hide();
                        layer.msg(res.msg, {icon: 2});
                    }
                } catch (e) {
                    $('#cf-progress').hide();
                    layer.msg('ä¸Šä¼ å¤±è´¥', {icon: 2});
                }
            } else {
                $('#cf-progress').hide();
                layer.msg('ä¸Šä¼ å¤±è´¥', {icon: 2});
            }
        };
        
        xhr.onerror = function() {
            $('#cf-progress').hide();
            layer.msg('ä¸Šä¼ å¤±è´¥', {icon: 2});
        };
        
        xhr.open('POST', '/plugin?action=a&s=upload_font&name=customfont');
        xhr.send(formData);
    },
    
    delete_font: function(font_id, font_name) {
        var self = this;
        layer.confirm('ç¡®å®šè¦åˆ é™¤å­—ä½“"' + font_name + '"å—ï¼Ÿ', {title: 'è­¦å‘Š'}, function(index) {
            layer.close(index);
            self.request('delete_font', {font_id: font_id}, function(res) {
                layer.msg(res.msg, {icon: res.status ? 1 : 2});
                if (res.status) {
                    self.show_fonts();
                }
            });
        });
    },
    
    reset_font: function() {
        var self = this;
        layer.confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤å­—ä½“å—ï¼Ÿ', {title: 'æç¤º'}, function(index) {
            layer.close(index);
            var load_index = layer.msg('æ­£åœ¨æ¢å¤...', {icon: 16, time: 0});
            self.request('apply_font', {}, function(res) {
                layer.close(load_index);
                layer.msg(res.msg, {icon: res.status ? 1 : 2});
                if (res.status) {
                    self.current_regular_font = '';
                    self.current_bold_font = '';
                    self.show_overview();
                }
            });
        });
    },
    
    go_to_fonts: function() {
        $(".bt-w-menu p").removeClass('bgw').eq(1).addClass('bgw');
        this.show_fonts();
    },
    
    request: function(func, args, callback) {
        $.ajax({
            type: 'POST',
            url: '/plugin?action=a&s=' + func + '&name=customfont',
            data: args,
            timeout: 60000,
            success: function(rdata) {
                if (callback) return callback(rdata);
            },
            error: function() {
                layer.msg('è¯·æ±‚å¤±è´¥', {icon: 2});
            }
        });
    }
};

customfont.init();
</script>